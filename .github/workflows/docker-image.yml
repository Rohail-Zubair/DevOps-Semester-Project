name: Appointments CI/CD

on:
  push:
    branches:
      - main
    paths:
      - 'appointments/**'
  pull_request:
    branches:
      - '*'
    paths:
      - 'appointments/**'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Get Changed Files
      id: files
      uses: jitterbit/get-changed-files@v1

    - name: Set Tag
      id: set_tag
      run: echo "::set-output name=tag::v3.$((GITHUB_RUN_NUMBER))"

    - name: Determine Changed Paths
      run: |
        CHANGED_PATHS="${{ steps.files.outputs.all }}"
        for FILE_PATH in $CHANGED_PATHS; do
          echo "File Path is: $FILE_PATH"
          DIRECTORY=$(dirname "${FILE_PATH}")
          echo "Directory is: $DIRECTORY"

          case "$DIRECTORY" in
            "appointments")
              CONTEXT_PATH="./appointments"
              ;;
            *)
              continue
              ;;
          esac
          TAG="${{ steps.set_tag.outputs.tag }}"
          DOCKER_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${DIRECTORY}:${TAG}"
          echo "docker Image is $DOCKER_IMAGE"
          echo ${{ secrets.DOCKERHUB_PASSWORD }} | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
          docker build -t $DOCKER_IMAGE $CONTEXT_PATH
          docker push $DOCKER_IMAGE
        done

  update-docker-compose:
    runs-on: ubuntu-latest
    needs:
      - build-and-push
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Get Changed Files
        id: files
        uses: jitterbit/get-changed-files@v1

      - name: Set Tag
        id: set_tag
        run: echo "::set-output name=tag::v3.$((GITHUB_RUN_NUMBER))"

      - name: Determine Changed Paths
        run: |
          CHANGED_PATHS="${{ steps.files.outputs.all }}"
          for FILE_PATH in $CHANGED_PATHS; do
            echo "File Path is: $FILE_PATH"
            DIRECTORY=$(dirname "${FILE_PATH}")
            echo "Directory is: $DIRECTORY"

            case "$DIRECTORY" in
              "appointments")
                UPDATED_SERVICE="appointments"
                ;;
              *)
                continue
                ;;
            esac

            TAG="${{ steps.set_tag.outputs.tag }}"
            echo "Tag is: $TAG"
            DOCKER_IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${UPDATED_SERVICE}:${TAG}"
            echo "Updating Docker Compose for $UPDATED_SERVICE with image $DOCKER_IMAGE"

            # Replace the image tag in the Docker Compose file
            sed -i "s#image: ${DIRECTORY}.*#image: ${DOCKER_IMAGE}#" "docker-compose.yml"
          done

      - name: Commit and Push Changes
        run: |
          git config --global user.email "rohailzubair263@gmail.com"
          git config --global user.name "Rohail-Zubair"
          git config pull.rebase false
          git add ./docker-compose.yml
          git commit -m "Update Docker Compose file with new appointment image tags"
          git pull origin main
          git push origin main
